var { setTimeout, clearTimeout } = require("sdk/timers");
var pageMod = require("sdk/page-mod");
var Preferences = require("sdk/simple-prefs");
var windows = require("sdk/windows").browserWindows;
var {viewFor} = require("sdk/view/core");
let aWindow = viewFor(windows.activeWindow);
pageMod.PageMod({
    include: /.*/,
    attachTo: ["existing", "top", "frame"],
    contentScriptFile: "./noclick.js",
    onAttach: function (worker) {
        let aWindow = viewFor(windows.activeWindow);
        Preferences.on("", onPrefChange = function () {
            worker.port.emit(
                "send_all_prefrences_to_user",
                Preferences.prefs['element_boarder_highlight_preference'],
                Preferences.prefs['element_boarder_highlight_color_preference'],
                Preferences.prefs['default_cursor_postion'],
                Preferences.prefs['mouse-over_selected_text'],
                Preferences.prefs['all_text_select_mouse-out'],
                Preferences.prefs['font_text_color'],
                Preferences.prefs['font_text_color_preference'],
                Preferences.prefs['element_background_color'],
                Preferences.prefs['element_background_color_preference'],
                Preferences.prefs['saved_cursor_postion_on_type'],
                Preferences.prefs['checkbox_autochecking_enabled'],
                Preferences.prefs['radiobutton_autoselecting_enabled'],
                Preferences.prefs['dropdown_autoshow_enabled']
            )
        });
        worker.port.emit(
            "send_all_prefrences_to_user",
            Preferences.prefs['element_boarder_highlight_preference'],
            Preferences.prefs['element_boarder_highlight_color_preference'],
            Preferences.prefs['default_cursor_postion'],
            Preferences.prefs['mouse-over_selected_text'],
            Preferences.prefs['all_text_select_mouse-out'],
            Preferences.prefs['font_text_color'],
            Preferences.prefs['font_text_color_preference'],
            Preferences.prefs['element_background_color'],
            Preferences.prefs['element_background_color_preference'],
            Preferences.prefs['saved_cursor_postion_on_type'],
            Preferences.prefs['checkbox_autochecking_enabled'],
            Preferences.prefs['radiobutton_autoselecting_enabled'],
            Preferences.prefs['dropdown_autoshow_enabled']
        )
    }
});
//noclicking tabs to switch
var timeoutID;
aWindow.gBrowser.tabContainer.addEventListener("mouseover",
    function (e) {
        aWindow.DownloadsPanel.hidePanel();
        if (Preferences.prefs['tab_focus_switching_enabled']) {
            function slowAlert() {
                event = e.target;
                if (event != null) {
                    //focus new tab
                    aWindow.gBrowser.selectedTab = event;
                    //delete event
                    event = null;
                }
            }
            clearTimeout(timeoutID);
           timeoutID = setTimeout(slowAlert, Preferences.prefs['tab_focus_switching_delay']);
        }
    }, false);

aWindow.gBrowser.tabContainer.addEventListener("mouseout",
    function (e) {

            clearTimeout(timeoutID);

    }, false);


//Noclick Search
aWindow.gURLBar.addEventListener("contextmenu", nc_context_menu_urlbar, false);
aWindow.gURLBar.addEventListener("mouseenter", nc_select_urlbar, false);
aWindow.gURLBar.addEventListener("click", nc_click_add_el_back, false);
aWindow.gURLBar.addEventListener("mouseout", nc_blur_urlbar, false);
function nc_blur_urlbar() {
    if (Preferences.prefs['url_focus_enabled']) {
        if(!aWindow.gURLBar.popupOpen){
            aWindow.gURLBar.blur()
        }}
}

function nc_click_add_el_back() {
    if (Preferences.prefs['url_focus_enabled']) {
        aWindow.gURLBar.addEventListener("mouseenter", nc_select_urlbar, false);
        aWindow.gURLBar.addEventListener("mouseout", nc_blur_urlbar, false);
    }
}
function nc_select_urlbar() {
    aWindow.DownloadsPanel.hidePanel();
    if (Preferences.prefs['url_focus_enabled']) {
        aWindow.gURLBar.click();
        aWindow.gURLBar.popup.openPopup(aWindow.document.getElementById("urlbar"), "after_start", 0, 0, false, false);
        aWindow.gURLBar.popup.width = aWindow.gURLBar.clientWidth;
    }
}
function nc_context_menu_urlbar () {
    if (Preferences.prefs['url_focus_enabled']) {
        aWindow.gURLBar.removeEventListener("mouseenter", nc_select_urlbar, false);
        aWindow.gURLBar.removeEventListener("mouseout", nc_blur_urlbar, false);
    }
}
//noclicking search bar
aWindow.document.getElementById("mainPopupSet").addEventListener("mouseleave", nc_mouseleave_search_popup, false);
aWindow.BrowserSearch.searchBar.addEventListener("mouseenter", nc_mouseenter_searchbar, false);
aWindow.BrowserSearch.searchBar.addEventListener("mouseout", nc_mouse_out_searchbar, false);
aWindow.BrowserSearch.searchBar.addEventListener("contextmenu", nc_context_menu_sb, false);
aWindow.BrowserSearch.searchBar.addEventListener("click", nc_click_sb, false);
function nc_context_menu_sb() {
    aWindow.BrowserSearch.searchBar.removeEventListener("mouseenter", nc_mouseenter_searchbar, false);
}
function nc_click_sb () {
    aWindow.BrowserSearch.searchBar.addEventListener("mouseenter", nc_mouseenter_searchbar, false);
}

function nc_mouseleave_search_popup() {
    if (Preferences.prefs['search_focus_enabled']) {
        aWindow.BrowserSearch.searchBar.textbox.open = false;
        aWindow.gURLBar.select();
        aWindow.gURLBar.blur();
    }
}
function nc_mouseenter_searchbar() {
    aWindow.DownloadsPanel.hidePanel(); //Hide Downloads Panel even if hover search bar is inactive
    if (Preferences.prefs['search_focus_enabled']) {
        if (aWindow.document.getElementById("toolbar-menubar").getAttribute("inactive")) {
            aWindow.gURLBar.click();
            aWindow.BrowserSearch.searchBar.textbox.select()
        }
    }
}
function nc_mouse_out_searchbar() {
    if (Preferences.prefs['search_focus_enabled']) {
        if (aWindow.document.getElementById("toolbar-menubar").getAttribute("inactive")) {
            if (aWindow.BrowserSearch.searchBar.textbox.value === "") {
                aWindow.gURLBar.select();
                aWindow.gURLBar.blur()
            }
        }
    }
}
/* Beginning of mouseover toolbars working
//File Toolbar menu
var file_menu_drop_down = aWindow.document.getElementById("file-menu");
file_menu_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    file_menu_drop_down.open = true
}, false);

file_menu_drop_down.addEventListener('mouseleave', function() {
    file_menu_drop_down.open = false
}, false);


//Edit Toolbar menu
var edit_menu_drop_down = aWindow.document.getElementById("edit-menu");
edit_menu_drop_down.addEventListener('mouseenter', function() {
    //aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    //edit_menu_drop_down.open = true
}, false);

edit_menu_drop_down.addEventListener('mouseleave', function() {
    edit_menu_drop_down.open = false
}, false);
*///beginning of mouseovers and end of start block. 1,2,3 This is (1)


/* //These are out because i have no way to mouseenter/mouseover sub-popupmenu's correctly without
//mouseingout of main popupmenu

//View Toolbar menu
var view_menu_drop_down = aWindow.document.getElementById("view-menu");
view_menu_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    view_menu_drop_down.open = true
}, true);

view_menu_drop_down.addEventListener('mouseout', function(e) {
    e.stopImmediatePropagation();
    view_menu_drop_down.open = false
}, false);

view_menu_drop_down.addEventListener('contextmenu', function() {
   // view_menu_drop_down.open = false
    console.log("contextMenuFired!!!!");
}, false);


//History Toolbar menu
var history_menu_drop_down = aWindow.document.getElementById("history-menu");
history_menu_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    history_menu_drop_down.open = true
}, false);

history_menu_drop_down.addEventListener('mouseleave', function() {
    history_menu_drop_down.open = false
}, false);


//BookMark Toolbar Menu
var bookmark_drop_down = aWindow.document.getElementById("bookmarksMenu");
bookmark_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    bookmark_drop_down.open = true
}, false);

bookmark_drop_down.addEventListener('mouseleave', function() {
    bookmark_drop_down.open = false
}, false);

//Tools Toolbar menu
var tool_menu_drop_down = aWindow.document.getElementById("tools-menu");
tool_menu_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    tool_menu_drop_down.open = true
}, false);

tool_menu_drop_down.addEventListener('mouseleave', function() {
    tool_menu_drop_down.open = false
}, false);
*/


/* Below is the end of the rest of toolbar menus that i need to fix.
//Help Toolbar menu
var help_menu_drop_down = aWindow.document.getElementById("helpMenu");
help_menu_drop_down.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    aWindow.DownloadsPanel.hidePanel();
    help_menu_drop_down.open = true
}, false);

help_menu_drop_down.addEventListener('mouseleave', function() {
    help_menu_drop_down.open = false
}, false);
*/
//BookMarkHistory
var history_menu = aWindow.document.getElementById("bookmarks-menu-button");
history_menu.addEventListener('mouseenter', function() {
    aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
    aWindow.DownloadsPanel.hidePanel();
    this.open = true
}, false);
history_menu.addEventListener('mouseleave', function() {
    this.open = false
}, false);

//Downloads Panel (What a pain, wtf is this b.s. structure..????)
aWindow.DownloadsPanel.initialize(function(){
    var download_drop_down = aWindow.document.getElementById("downloads-button");
    var download_drop_down_panel = aWindow.document.getElementById("downloadsFooter");

    download_drop_down.addEventListener('mouseenter', function(e) {
        aWindow.PanelUI.hide(); //Hide Hamburger Button Panel
        download_drop_down.open = true;
        aWindow.DownloadsPanel.showPanel();
    }, false);

    download_drop_down_panel.addEventListener('mouseleave', function() {
        download_drop_down.open = false;
        aWindow.DownloadsPanel.hidePanel();
    }, false);
});

function setDownloadWindowNow() {

}

//Hamburger Panel
var hamburger_drop_down = aWindow.document.getElementById("PanelUI-menu-button");
var hamburger_main_drop_down_panel = aWindow.document.getElementById("PanelUI-mainView");
hamburger_drop_down.addEventListener('mouseover', function() {
    aWindow.DownloadsPanel.hidePanel();
    aWindow.PanelUI.show()
}, false);

hamburger_main_drop_down_panel.addEventListener('mouseleave', function() {
    aWindow.PanelUI.hide()
}, true);




/* Autoshow menutoolbar
//aWindow.menubar.visible = true;
require("sdk/preferences/service").set("extensions.hidemenubar.autoshow", true);

var toolbar_menubar = aWindow.document.querySelector("#toolbar-menubar");
toolbar_menubar.setAttribute("autohide", false);

*/